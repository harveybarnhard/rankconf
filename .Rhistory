library(rankconf)
usethis::use_rcpp()
usethis::use_rcpp_armadillo()
library(rankconf)
library(rankconf)
timesTwo(2)
library(rankconf)
timesTwo(2)
library(rankconf)
timesTwo(1)
library(rankconf)
library(rankconf)
rankconf::timesTwo(1)
library(rankconf)
getLoadedDLLs()
library(rankconf)
library(rankconf)
library(rankconf)
library(rankconf)
library(rankconf)
Rcpp::compileAttributes()
library(rankconf)
?order
data.table::order(c(1,2,3))
?chorder
order(c(2,1,3))
kmin = function(x, k){
k = min(length(x), k)
if(k>1000){
partial = length(x) - k + 1
return(
x[x >= sort(x, partial=partial)[partial]]
)
}else{
return(
x[kit::topn(x, k, decreasing=F)[k]]
)
}
}
x = runif(1000)
x = runif(100000)
?sort
kmin(x, 1)
kmin(x, 10)
kmin(x, 1000)
kmin(x, 1001)
kmin = function(x, k){
k = min(length(x), k)
if(k>1000){
partial = length(x) - k + 1
return(
x[x >= sort(x, partial=partial, decreasing=F)[k]]
)
}else{
return(
x[kit::topn(x, k, decreasing=F)[k]]
)
}
}
kmin(x, 1001)
kmin(x, 1000)
kmin(x, 1001)
?order
kmin = function(x, k){
k = min(length(x), k)
if(k>1000){
partial = length(x) - k + 1
return(
x[order(x, partial=partial, decreasing=F)[k]]
)
}else{
return(
x[kit::topn(x, k, decreasing=F)[k]]
)
}
}
kmin(x, 1001)
order(x, partial=2)
order(x, partial=2, decreasing=F
)
kmin = function(x, k){
k = min(length(x), k)
if(k>1000){
p = length(x) - k + 1
return(
x[sort(x, partial=p, decreasing=F)[p]]
)
}else{
return(
x[kit::topn(x, k, decreasing=F)[k]]
)
}
}
kmin = function(x, k){
k = min(length(x), k)
if(k>1000){
p = length(x) - k + 1
return(
sort(x, partial=p, decreasing=F)[p]
)
}else{
return(
x[kit::topn(x, k, decreasing=F)[k]]
)
}
}
kmin(x, 1001)
kmin(x, 1000)
kmin = function(x, k){
k = min(length(x), k)
if(k>1000){
p = length(x) - k + 1
return(
sort(x, partial=p, decreasing=T)[p]
)
}else{
return(
x[kit::topn(x, k, decreasing=F)[k]]
)
}
}
kmin(x, 1000)
kmin(x, 1001)
sort(x, partial=2, decreasing=T)
sort(-x, partial=2, decreasing=F)
kmin = function(x, k){
k = min(length(x), k)
if(k>1000){
p = length(x) - k + 1
return(
-sort(-x, partial=p, decreasing=T)[p]
)
}else{
return(
x[kit::topn(x, k, decreasing=F)[k]]
)
}
}
kmin(x, 1001)
kmin = function(x, k){
k = min(length(x), k)
if(k>1000){
p = length(x) - k + 1
return(
-sort(-x, partial=p, decreasing=F)[p]
)
}else{
return(
x[kit::topn(x, k, decreasing=F)[k]]
)
}
}
kmin(x, 1001)
kmin(x, 1000)
microbenchmark(kmin(x,1001), kmin(x,1000))
microbenchmark::microbenchmark(kmin(x,1001), kmin(x,1000))
microbenchmark::microbenchmark(kmin(x,1001), kmin(x,1000))
microbenchmark::microbenchmark(kmin(x,1001), kmin(x,1000))
microbenchmark::microbenchmark(kmin(x,1001), kmin(x,1000))
simfun = function(n, g, r, nullprop=0){
sigvar = r/((1-r)*n)
if(nullprop>0 & nullprop < 1){
numnull = floor(nullprop*g)
y = rnorm(g, mean=0, sd=sqrt(sigvar)/sqrt(1-nullprop))
y[sample.int(g, numnull)] = 0
}else if(nullprop==1){
y = rep(0, g)
}else{
y = rnorm(g, mean=0, sd=sqrt(sigvar))
}
df = data.table::data.table(
id = rep(1:g, 1, each=n),
yi  = rnorm(n*g, mean=rep(y, 1, each=n), sd=1)
)
df = df[,
list(yhat=mean(yi),
sig2=var(yi)/n),
by=id
]
df[, id:=NULL]
df$y = y
return(df)
}
df = simfun(50, 500, 0.8, nullprop=0)
profvis::profvis({
rankconf(df$yhat, df$sig2, type="BKFWER", k=500)
})
library(rankconf)
profvis::profvis({
rankconf(df$yhat, df$sig2, type="BKFWER", k=500, thr=parallel::detectCores()-1)
})
simfun = function(n, g, r, nullprop=0){
sigvar = r/((1-r)*n)
if(nullprop>0 & nullprop < 1){
numnull = floor(nullprop*g)
y = rnorm(g, mean=0, sd=sqrt(sigvar)/sqrt(1-nullprop))
y[sample.int(g, numnull)] = 0
}else if(nullprop==1){
y = rep(0, g)
}else{
y = rnorm(g, mean=0, sd=sqrt(sigvar))
}
df = data.table::data.table(
id = rep(1:g, 1, each=n),
yi  = rnorm(n*g, mean=rep(y, 1, each=n), sd=1)
)
df = df[,
list(yhat=mean(yi),
sig2=var(yi)/n),
by=id
]
df[, id:=NULL]
df$y = y
return(df)
}
df = simfun(50, 500, 0.8, nullprop=0)
profvis::profvis({
rankconf(df$yhat, df$sig2, type="BKFWER", k=500, thr=parallel::detectCores()-1)
})
parallel::detectCores()
profvis::profvis({
rankconf(df$yhat, df$sig2, type="BKFWER", k=500, thr=parallel::detectCores()-1)
})
library(rankconf)
profvis::profvis({
rankconf(df$yhat, df$sig2, type="BKFWER", k=500, thr=parallel::detectCores()-1)
})
library(rankconf)
source('Z:/rankconf/USA_tracts.R')
message("Rank 1 corresponds to the lowest estimate\n")
message("Rank 1 corresponds to the lowest estimate\n")
cat("hello")
message("Rank 1 corresponds to the lowest estimate\n")
cat("hello")
message("Rank 1 corresponds to the lowest estimate\n")
cat("hello")
library(rankconf)
library(rankconf)
simfun = function(n, g, r, nullprop=0){
sigvar = r/((1-r)*n)
if(nullprop>0 & nullprop < 1){
numnull = floor(nullprop*g)
y = rnorm(g, mean=0, sd=sqrt(sigvar)/sqrt(1-nullprop))
y[sample.int(g, numnull)] = 0
}else if(nullprop==1){
y = rep(0, g)
}else{
y = rnorm(g, mean=0, sd=sqrt(sigvar))
}
df = data.table::data.table(
id = rep(1:g, 1, each=n),
yi  = rnorm(n*g, mean=rep(y, 1, each=n), sd=1)
)
df = df[,
list(yhat=mean(yi),
sig2=var(yi)/n),
by=id
]
df[, id:=NULL]
df$y = y
return(df)
}
df = simfun(50, 500, 0.8, nullprop=0)
test = list()
test[["FDR"]] = rankconf(df$yhat, df$sig2, type="FDR", alpha=0.3)
test = list()
test[["Mogstad"]] = csranks::csranks(-df$yhat, sqrt(df$sig2))
test[["1-FWER"]] = rankconf(df$yhat, df$sig2, type="BKFWER", k=1, thr=parallel::detectCores()-1)
test[["500-FWER"]] = rankconf(df$yhat, df$sig2, type="BKFWER", k=100, thr=parallel::detectCores()-1)
ggplot(df, aes(x=rank(yhat), y=rank(y))) +
geom_point() +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$L), color="black") +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$U), color="black") +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$L), color="blue") +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$U), color="blue") +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["1-FWER"]]$L, color="red")) +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["1-FWER"]]$U, color="red")) +
theme_classic() +
theme(
axis.title.x = element_text("Estimated Rank"),
axis.title.y = element_text("True Rank")
)
library(ggplot)
library(ggplot2)
ggplot(df, aes(x=rank(yhat), y=rank(y))) +
geom_point() +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$L), color="black") +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$U), color="black") +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$L), color="blue") +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$U), color="blue") +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["1-FWER"]]$L, color="red")) +
geom_smooth(mapping=aes(x=rank(df$yhat), y=test[["1-FWER"]]$U, color="red")) +
theme_classic() +
theme(
axis.title.x = element_text("Estimated Rank"),
axis.title.y = element_text("True Rank")
)
ggplot(df, aes(x=rank(yhat), y=rank(y))) +
geom_point() +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$L), color="black") +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$U), color="black") +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$L), color="blue") +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$U), color="blue") +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["1-FWER"]]$L, color="red")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["1-FWER"]]$U, color="red")) +
theme_classic() +
theme(
axis.title.x = element_text("Estimated Rank"),
axis.title.y = element_text("True Rank")
)
ggplot(df, aes(x=rank(yhat), y=rank(y))) +
geom_point() +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$L, color="black")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$U, color="black")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$L, color="blue")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$U, color="blue")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["1-FWER"]]$L, color="red")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["1-FWER"]]$U, color="red")) +
theme_classic() +
xlab("Estimated Rank") + ylab("True Rank")
test[["FDR"]] = rankconf(df$yhat, df$sig2, type="FDR", alpha=0.05)
ggplot(df, aes(x=rank(yhat), y=rank(y))) +
geom_point() +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$L, color="black")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["Mogstad"]]$U, color="black")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$L, color="blue")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["500-FWER"]]$U, color="blue")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["FDR"]]$L, color="red")) +
geom_point(mapping=aes(x=rank(df$yhat), y=test[["FDR"]]$U, color="red")) +
theme_classic() +
xlab("Estimated Rank") + ylab("True Rank")
?fwrite
# Load data ====================================================================
df = data.table::fread("https://opportunityinsights.org/wp-content/uploads/2018/10/tract_outcomes_simple.csv")
var(df$kfr_pooled_pooled_p25)/(mean(df$kfr_pooled_pooled_p25_se^2))
var(df$kfr_pooled_pooled_p25, na.rm=T)/(mean(df$kfr_pooled_pooled_p25_se^2, na.rm=T))
(mean(df$kfr_pooled_pooled_p25_se^2, na.rm=T))/var(df$kfr_pooled_pooled_p25, na.rm=T)/
(mean(df$kfr_pooled_pooled_p25_se^2, na.rm=T))/var(df$kfr_pooled_pooled_p25, na.rm=T)
library(rankconf)
simfun = function(n, g, r, nullprop=0){
sigvar = r/((1-r)*n)
if(nullprop>0 & nullprop < 1){
numnull = floor(nullprop*g)
y = rnorm(g, mean=0, sd=sqrt(sigvar)/sqrt(1-nullprop))
y[sample.int(g, numnull)] = 0
}else if(nullprop==1){
y = rep(0, g)
}else{
y = rnorm(g, mean=0, sd=sqrt(sigvar))
}
df = data.table::data.table(
id = rep(1:g, 1, each=n),
yi  = rnorm(n*g, mean=rep(y, 1, each=n), sd=1)
)
df = df[,
list(yhat=mean(yi),
sig2=var(yi)/n),
by=id
]
df[, id:=NULL]
df$y = y
return(df)
}
df = simfun(50, 500, 0.8, nullprop=0)
profvis::profvis({
rankconf(df$yhat, df$sig2, type="BKFWER", k=500)
})
library(rankconf)
profvis::profvis({
rankconf(df$yhat, df$sig2, type="BKFWER", k=500)
})
microbenchmark(
"[32, 11]"      = mtcars[32, 11],
"$carb[32]"     = mtcars$carb[32],
"[[c(11, 32)]]" = mtcars[[c(11, 32)]],
"[[11]][32]"    = mtcars[[11]][32],
".subset2"      = .subset2(mtcars, 11)[32]
)
library(microbenchmark)
microbenchmark(
"[32, 11]"      = mtcars[32, 11],
"$carb[32]"     = mtcars$carb[32],
"[[c(11, 32)]]" = mtcars[[c(11, 32)]],
"[[11]][32]"    = mtcars[[11]][32],
".subset2"      = .subset2(mtcars, 11)[32]
)
